name: Build and Deploy Documentation

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
    paths:
      - 'docs/**'
      - 'docs/mkdocs.yml'
      - 'docs/pyproject.toml'

permissions:
  contents: write
  pages: write
  id-token: write

# Allow one concurrent deployment
concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  # Build job
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"
      
      - name: Setup Pages
        id: pages
        uses: actions/configure-pages@v4
      
      - name: Install dependencies
        working-directory: docs
        run: uv sync
      
      - name: Configure MkDocs for repository
        working-directory: docs
        run: |
          uv run python3 << 'PYEOF'
          import yaml
          import os
          
          REPO_OWNER = os.environ['REPO_OWNER']
          REPO_NAME = os.environ['REPO_NAME']
          SITE_URL = os.environ['SITE_URL']
          DEFAULT_BRANCH = os.environ['DEFAULT_BRANCH']
          
          with open('mkdocs.yml', 'r', encoding='utf-8') as f:
              config = yaml.safe_load(f)
          
          # 更新 site_url
          config['site_url'] = SITE_URL
          
          # 更新 repo_url 和 repo_name
          config['repo_url'] = f'https://github.com/{REPO_OWNER}/{REPO_NAME}'
          config['repo_name'] = f'{REPO_OWNER}/{REPO_NAME}'
          
          # 更新 edit_uri
          config['edit_uri'] = f'edit/{DEFAULT_BRANCH}/docs/docs/'
          
          with open('mkdocs.yml', 'w', encoding='utf-8') as f:
              yaml.dump(config, f, allow_unicode=True, default_flow_style=False, sort_keys=False)
          PYEOF
        env:
          REPO_OWNER: ${{ github.repository_owner }}
          REPO_NAME: ${{ github.event.repository.name }}
          SITE_URL: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}
          DEFAULT_BRANCH: ${{ github.event.repository.default_branch }}
          PYTHONIOENCODING: utf-8
      
      - name: Build with MkDocs
        working-directory: docs
        run: uv run mkdocs build --site-dir ../site
        env:
          BASE_URL: "${{ steps.pages.outputs.base_path }}"
      
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: site

  # Deployment job
  deploy:
    # 在 fork 仓库中也允许部署（如果启用了 GitHub Pages）
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' || github.ref == 'refs/heads/feat/docs'
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
