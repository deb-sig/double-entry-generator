name: Build and Deploy Documentation

on:
  push:
    # 所有分支都可以触发构建，但只有 main/master 会部署
    paths:
      - 'docs/**'
      - 'docs/mkdocs.yml'
      - 'docs/pyproject.toml'
      - '.github/workflows/docs.yml'
  pull_request:
    # PR 也会触发构建（用于检查）
    paths:
      - 'docs/**'
      - 'docs/mkdocs.yml'
      - 'docs/pyproject.toml'
      - '.github/workflows/docs.yml'

permissions:
  contents: write
  pages: write
  id-token: write

# Allow one concurrent deployment
concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  # Build job
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"
      
      - name: Setup Pages
        id: pages
        uses: actions/configure-pages@v4
      
      - name: Install dependencies
        working-directory: docs
        run: uv sync
      
      - name: Configure MkDocs for repository
        working-directory: docs
        run: |
          uv run python3 << 'PYEOF'
          import yaml
          import os
          import re
          
          REPO_OWNER = os.environ['REPO_OWNER']
          REPO_NAME = os.environ['REPO_NAME']
          SITE_URL = os.environ['SITE_URL']
          DEFAULT_BRANCH = os.environ['DEFAULT_BRANCH']
          
          # 读取文件内容
          with open('mkdocs.yml', 'r', encoding='utf-8') as f:
              content = f.read()
          
          # 使用字符串替换更新配置，避免解析 Python 对象标签
          content = re.sub(r"^site_url:\s*.*$", f"site_url: {SITE_URL}", content, flags=re.MULTILINE)
          content = re.sub(r"^repo_url:\s*.*$", f"repo_url: https://github.com/{REPO_OWNER}/{REPO_NAME}", content, flags=re.MULTILINE)
          content = re.sub(r"^repo_name:\s*.*$", f"repo_name: {REPO_OWNER}/{REPO_NAME}", content, flags=re.MULTILINE)
          content = re.sub(r"^edit_uri:\s*.*$", f"edit_uri: edit/{DEFAULT_BRANCH}/docs/docs/", content, flags=re.MULTILINE)
          
          # 写回文件
          with open('mkdocs.yml', 'w', encoding='utf-8') as f:
              f.write(content)
          PYEOF
        env:
          REPO_OWNER: ${{ github.repository_owner }}
          REPO_NAME: ${{ github.event.repository.name }}
          SITE_URL: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}
          DEFAULT_BRANCH: ${{ github.event.repository.default_branch }}
          PYTHONIOENCODING: utf-8
      
      - name: Build with MkDocs
        working-directory: docs
        run: uv run mkdocs build --site-dir ../site
        env:
          BASE_URL: "${{ steps.pages.outputs.base_path }}"
      
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: site

  # Deployment job
  deploy:
    # 在 fork 仓库中也允许部署（如果启用了 GitHub Pages）
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' || github.ref == 'refs/heads/feat/docs'
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
